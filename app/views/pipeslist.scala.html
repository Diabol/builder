@(pipes: List[models.statusdata.Pipe])

@import models.statusdata._

@headers = {
    <script src="@routes.Assets.at("javascripts/graph-it/js-graph-it.js")" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/jsplumb/jquery.jsPlumb-1.3.13-all.js")" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="@routes.Assets.at("stylesheets/graph-it/js-graph-it.css")" />
}

@addEdge(parentId: String, childId: String) = {
    <div class="connector @{parentId} @{childId} right_start">
        <img class="connector-end" src="@routes.Assets.at("images/graph-it/fastforward.png")">
    </div>
}

@createPipeMarkup(pipeCount: Int, pipe: Pipe) = {
    @for(phaseCount <- 0 until pipe.phases.length){
        <div id="@{pipe.name}@{pipe.phases.get(phaseCount).name}" class="phase block @{pipe.name}" style="left: @{20+phaseCount*320}px; top: 120px;">@{PipeListHelper.generateMarkupForPhase(pipe, pipe.phases.get(phaseCount))}</div>
        @if(phaseCount > 0) {
             @addEdge(pipe.name+pipe.phases.get(phaseCount-1).name, pipe.name+pipe.phases.get(phaseCount).name)
        }
    } 
}

@html =  {
    <script>
    	//Variable for keeping track of which versions of each pipe is shown.
        var shownPipeVersions = {};
        @for(i <- 0 until pipes.length){
        	shownPipeVersions['@{pipes.get(i).name}'] = "@{pipes.get(i).version}";
        }
        window.onload = function() {
            initPageObjects();
        }
        
        function resetPhases(className){
        	$('.'+className).animate({ backgroundColor: 'white' }, 'fast');
        	$('.'+className).find('#started').html("Started: Not yet started");
    		$('.'+className).find('#finished').html("Finished: Not yet finished");
        }
        
        function resetPipeVersionInfo(className, version, commitId, commitMsg) {
        	$('.'+className).find('#pipeVersion').html('Version: ' + version);
    		$('.'+className).find('#commitId').html(commitId);
    		$('.'+className).find('#commitText').html(commitMsg);
        }
        function highlightPhase(pipeName, phaseName) {
            if(selectedPhase &&  selectedPipe){
                $('#'+selectedPipe+selectedPhase).removeClass('phaseHighlighted');
            }
            $('#'+pipeName+phaseName).addClass('phaseHighlighted');
            selectedPhase = phaseName;
            selectedPipe = pipeName;
        }
        
        function updateTask(updateTaskData) {
        	function colorizeTask(colour) {
        		$('#'+updateTaskData.pipeName+updateTaskData.phaseName+updateTaskData.taskName).animate({ backgroundColor: colour }, 'slow');
        	}
        	switch(updateTaskData.status) {
        	case "RUNNING":
        		colorizeTask("#b5e0f7");
    			break;
        	case "SUCCESS":
        		colorizeTask("#64cc7b")
    			break;
        	case "FAILURE":
        		colorizeTask("#d25353");
    			break;
        	}
        }

        function updatePhase(updatePhaseData) {
        	var domNodeId = updatePhaseData.pipeName+updatePhaseData.phaseName;
        	function colorizePhase(colour) {
        		/*$('#'+domNodeId).animate({ backgroundColor: colour }, 'fast');*/
                alert($('#'+domNodeId).find('#started').html);
        		$('#'+domNodeId).find('#started').html("Started: " +updatePhaseData.started.format("MMM dd, HH:mm:ss"));
        		$('#'+domNodeId).find('#finished').html("Finished: " +updatePhaseData.finished.format("MMM dd, HH:mm:ss"));
        	}
        	switch(updatePhaseData.status) {
        	case "RUNNING":
                colorizeTask("#C0E3F7");
    			break;
        	case "SUCCESS":
                colorizeTask("#AAFFC4")
    			break;
        	case "FAILURE":
                colorizeTask("#FFD8DA");
    			break;
        	}
        }
    </script>
    <script>
        $(function() {
            var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
            var chatSocket = new WS("@routes.Pipes.setupSocket().webSocketURL(request)")

            var sendMessage = function() {
            }

            var receiveEvent = function(event) {
                var data = JSON.parse(event.data);
                console.log(data);
                // Handle errors
                if(data.error) {
                    chatSocket.close();
                    alert('An error has occured while executing a pipeline. Please refer to server log.');
                    return
                } else if(data.phaseUpdate) {
                	if(shownPipeVersions[data.pipeName] == data.version) {
                    	updatePhase(data);
                	}
                } else if(data.taskUpdate) {
                	if(shownPipeVersions[data.pipeName] == data.version){
                		//The updated task is visible
                		updateTask(data);
                	}
                } else if(data.newPipeVersion) {
                	shownPipeVersions[data.pipeName] = data.version;
                	resetPhases(data.pipeName);
                	resetPipeVersionInfo(data.pipeName, data.version, data.commitId, data.commitMsg);
                }

            }

            chatSocket.onmessage = receiveEvent

        })
    </script>
    <div id="pipeList">
    @for(i <- 0 until pipes.length){
        <div id="@{pipes(i).name}canvas" class="canvas component @{pipes(i).name}" style="width: 100%; height: 300px; padding-top: 10px;">
            <h2><span class="componentName">@{pipes(i).name}</span>  <span id="pipeVersion" class="componentVersion">Version: @{pipes(i).version}</span></h2>
            <div id="revisionInfo">
                <label>Change info: </label>
                <span id="commitId">@{pipes(i).versionControlInfo.versionControlId}</span> : <span id="commitText">@{pipes(i).versionControlInfo.versionControlText}</span>
            </div>
            @createPipeMarkup(i, pipes(i))
        </div>
    }
    </div>
}

@main("Pipe List", headers)(html)