@(pipes: List[models.config.PipeConfig])

@import models.config._

@headers = {
    <script src="@routes.Assets.at("javascripts/graph-it/js-graph-it.js")" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/jsplumb/jquery.jsPlumb-1.3.13-all.js")" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="@routes.Assets.at("stylesheets/graph-it/js-graph-it.css")" />
}

@createPipeScripts(pipeCount: Int, pipe: PipeConfig) = {
    @for(phaseCount <- 0 until pipe.getPhases().length){
        function displayPhase@{pipeCount}@{phaseCount}() {
            taskSelected = undefined;
            highlightPhase('@{pipe.getName()}@{pipe.getPhases().get(phaseCount).getName()}');
            $("#tasks").html("@{PipeListHelper.generateMarkupForTaskTree(pipe.getPhases.get(phaseCount))}");
        }
    }
}

@addEdge(parentId: String, childId: String) = {
    <div class="connector @{parentId} @{childId} right_start">
        <img class="connector-end" src="@routes.Assets.at("images/graph-it/arrow.gif")">
    </div>
}

@createPhaseText(phase: PhaseConfig) = {
    @{phase.getName()}<br>Last success: N/A</br><br>Status: NOT STARTED</br>
}

@createPipeMarkup(pipeCount: Int, pipe: PipeConfig) = {
    @for(phaseCount <- 0 until pipe.getPhases().length){
        <h2 id="@{pipe.getName()}@{pipe.getPhases().get(phaseCount).getName()}" onclick="displayPhase@{pipeCount}@{phaseCount}();" class="block" style="left: @{30+phaseCount*300}px; top: @{100+200*pipeCount}px;">@createPhaseText(pipe.getPhases().get(phaseCount))</h2>
        @if(phaseCount > 0) {
             @addEdge(pipe.getName()+pipe.getPhases().get(phaseCount-1).getName(), pipe.getName()+pipe.getPhases().get(phaseCount).getName())
        }
    }
}

@html =  {
    <script>
        //Variable used for keeping track of which phase is selected.
        var phaseIdSelected;
        window.onload = function() {
            initPageObjects();
        }

        function highlightPhase(id) {
            if(phaseIdSelected){
                $('#'+phaseIdSelected).removeClass('phaseHighlighted');
            }
            $('#'+id).addClass('phaseHighlighted');
            phaseIdSelected = id;
        }

        function updatePhase(phaseId) {
            $('#'+phaseId).addClass("successfull");
        }

        <!--Generated javascript functions for displaying the task trees-->
        @for(i <- 0 until pipes.length){
            @createPipeScripts(i, pipes(i))
        }
    </script>
    <script>
        $(function() {
            var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
            var chatSocket = new WS("@routes.Pipes.setupSocket().webSocketURL(request)")

            var sendMessage = function() {
            }

            var receiveEvent = function(event) {
                var data = JSON.parse(event.data)

                // Handle errors
                if(data.error) {
                    chatSocket.close()
                    alert('An has occured while executing a pipe line. Please refer to server log.');
                    return
                } else if(data.phaseUpdate) {
                    updatePhase(data.pipeName+data.phaseName);
                }

            }

            chatSocket.onmessage = receiveEvent

        })
    </script>
    <table class="main_table" style="height: 100%;">
        <tr>
            <td style="vertical-align: top; padding: 0px;">
                <div class="canvas" style="width: 100%; height: 200px;">
                    <div id="tasks">
                        <div id='taskHeader'>Tasks</div>
                    </div>
                </div>
                <div id="mainCanvas" class="canvas" style="width: 100%; height: 500px;">
                    <div id="pipeList">Component pipes
                    @for(i <- 0 until pipes.length){
                        <div class="pipe">
                            @createPipeMarkup(i, pipes(i))
                        </div>
                    }
                    </div>
                </div>
             </td>
        </tr>
    </table>
}

@main("Pipe List", headers)(html)