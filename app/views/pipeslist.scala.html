@(pipes: List[models.statusdata.Pipe])

@import models.statusdata._

@headers = {
    <script src="@routes.Assets.at("javascripts/graph-it/js-graph-it.js")" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.13/jquery-ui.min.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="@routes.Assets.at("stylesheets/graph-it/js-graph-it.css")" />
}

@html =  {
    <script>
    	//Variable for keeping track of which versions of each pipe is shown.
        var shownPipeVersions = {};
    	function generatePhaseMarkup(pipe, phase) {
    		var result = "";
    		result = result + "<h3>" + phase.name + "</h3>";
    		result = result + "<div class='right'>";
            if(phase.startedAsString) {
            	result = result + "<span id='started'>"+phase.startedAsString+"</span>";
            } else {
            	result = result + "<span id='started'></span>";
            }
            if(phase.finishedAsString){
            	result = result + "<span id='finished'>  ->  "+phase.finishedAsString+"</span>";
            } else {
            	result = result + "<span id='finished'></span>";
            }
            result = result + "</div>";
    		result = result + "<hr/>";
            result = result + "<div id='tasks' >";
            for (var taskCount = 0; taskCount < phase.tasks.length; taskCount++) {
                var task = phase.tasks[taskCount];
                var onclick = "onClick=\"getTaskDetails('" + pipe.name +":" + phase.name +":"+ task.name+"')\"";
                result = result + "<div id='" + pipe.name + phase.name + task.name + "' " + onclick + " class='task "
                        + task.state + " " + pipe.name + "' style='left: " + (5 + taskCount * 30)
                        + "px;' on><div class='taskInfo'><label>"+task.name+"</label></div></div>";
            }
            result = result +"<div class='clear'></div>";
            result = result + "</div>";
            
            return result;
    	}
    	
        function createPipeMarkup(pipes) {
        	for(var pipeCount = 0; pipeCount < pipes.length; pipeCount++){
        		var pipe =  pipes[pipeCount];
	            for(var phaseCount = 0; phaseCount < pipe.phases.length; phaseCount++){
	            	var phase = pipe.phases[phaseCount];
	            	$('#'+pipe.name+'canvas').append("<div id='" + pipe.name + phase.name + "' class='phase block " + pipe.name + "' style='left: "+(20+phaseCount*320)+"px; top: 120px;'>"+generatePhaseMarkup(pipe, phase)+"</div>");
	            } 
        	}
        }
        @for(i <- 0 until pipes.length){
        	shownPipeVersions['@{pipes.get(i).name}'] = "@{pipes.get(i).version}";
        }
        window.onload = function() {
            initPageObjects();
            
        }
        
        function resetPhases(className){
        	$('.'+className).animate({ backgroundColor: 'white' }, 'fast');
        	$('.'+className).find('#started').html("");
    		$('.'+className).find('#finished').html("");
        }
        
        function resetPipeVersionInfo(className, version, commitId, commitMsg) {
        	$('.'+className).find('#pipeVersion').html('Version: ' + version);
    		$('.'+className).find('#versionControlInfo').find('#commitId').html(commitId);
    		$('.'+className).find('#versionControlInfo').find('#commitText').html(commitMsg);
        }
        function highlightPhase(pipeName, phaseName) {
            if(selectedPhase &&  selectedPipe){
                $('#'+selectedPipe+selectedPhase).removeClass('phaseHighlighted');
            }
            $('#'+pipeName+phaseName).addClass('phaseHighlighted');
            selectedPhase = phaseName;
            selectedPipe = pipeName;
        }
        
        function updateTask(updateTaskData) {
        	function colorizeTask(colour) {
        		$('#'+updateTaskData.pipeName+updateTaskData.phaseName+updateTaskData.taskName).animate({ backgroundColor: colour }, 'slow');
        	}
        	switch(updateTaskData.status) {
        	case "RUNNING":
        		colorizeTask("#b5e0f7");
    			break;
        	case "SUCCESS":
        		colorizeTask("#64cc7b")
    			break;
        	case "FAILURE":
        		colorizeTask("#d25353");
    			break;
        	}
        }

        function updatePhase(updatePhaseData) {
        	var domNodeId = updatePhaseData.pipeName+updatePhaseData.phaseName;
        	function colorizePhase(colour) {
        		//$('#'+domNodeId).animate({ backgroundColor: colour }, 'fast');
        		if(updatePhaseData.started) {
        			$('#'+domNodeId).find('#started').html(updatePhaseData.started);
        		}
        		if(updatePhaseData.finished) {
        			$('#'+domNodeId).find('#finished').html("  ->  "+updatePhaseData.finished);
        		}
        	}
        	switch(updatePhaseData.status) {
        	case "RUNNING":
        		colorizePhase("#C0E3F7");
    			break;
        	case "SUCCESS":
        		colorizePhase("#AAFFC4")
    			break;
        	case "FAILURE":
        		colorizePhase("#FFD8DA");
    			break;
        	}
        }
        
        function subStringCommitId(commitId) {
        	var result = commitId.substring(0, 6) +"...";
        	return result;
        }
        
        $(function() {
            var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
            var chatSocket = new WS("@routes.Pipes.setupSocket().webSocketURL(request)")

            var sendMessage = function() {
            }

            var receiveEvent = function(event) {
                var data = JSON.parse(event.data);
                console.log(data);
                // Handle errors
                if(data.error) {
                    chatSocket.close();
                    alert('An error has occured while executing a pipeline. Please refer to server log.');
                    return
                } else if(data.phaseUpdate) {
                	if(shownPipeVersions[data.pipeName] == data.version) {
                    	updatePhase(data);
                	}
                } else if(data.taskUpdate) {
                	if(shownPipeVersions[data.pipeName] == data.version){
                		//The updated task is visible
                		updateTask(data);
                	}
                } else if(data.newPipeVersion) {
                	shownPipeVersions[data.pipeName] = data.version;
                	resetPhases(data.pipeName);
                	resetPipeVersionInfo(data.pipeName, data.version, data.commitId, data.commitMsg);
                }

            }

            chatSocket.onmessage = receiveEvent

        })
        $.ajax({
            	  url: '/pipes/latest',
            	  success: createPipeMarkup,
            	});
    </script>
    <div id="pipeList">
    @for(i <- 0 until pipes.length){
        <div id="@{pipes(i).name}canvas" class="canvas component @{pipes(i).name}" style="width: 100%; height: 200px; padding-top: 10px;">
            <h2><span class="componentName">@{pipes(i).name}</span>  
            <span id="pipeVersion" class="componentVersion">Version: @{pipes(i).version}</span>
            <span id='versionControlInfo' class='right'>
            	<span id="commitId">@{pipes(i).versionControlInfo.versionControlId}</span>
            	<span>: </span>
            	<span id="commitText">@{pipes(i).versionControlInfo.versionControlText}</span>
            </span>
            </h2>
        </div>
    }
    </div>
}

@main("Pipe List", headers)(html)